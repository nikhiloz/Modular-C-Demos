@startuml
skinparam backgroundColor #FEFEFE
skinparam defaultFontSize 13
skinparam activityBorderColor #333333
skinparam activityBackgroundColor #E8F4FD
skinparam activityDiamondBackgroundColor #FFF3CD
skinparam activityDiamondBorderColor #856404
skinparam roundCorner 8
skinparam shadowing false

title CRT Startup and Shutdown Sequence

start

partition "Assembly Entry (crt1.o)" #E8EAF6 {
  :_start begins execution (ASM);
  :Zero the frame pointer (%rbp = 0)
    for clean backtraces;
  :Pop argc from stack into %rdi;
  :Set argv pointer (%rsi = %rsp);
  :Align stack to 16-byte boundary;
  :Push argc and argv onto aligned stack;
  :Call **__libc_start_main**(
    main, argc, argv,
    __libc_csu_init,
    __libc_csu_fini,
    rtld_fini, stack_end
    );
}

partition "libc Initialization (libc.so)" #E0F2F1 {
  :Set up Thread-Local Storage (TLS);
  :Initialize stack canary (stack guard);
  :Set up stdio (stdin, stdout, stderr);
  :Initialize errno and locale;
  :Register rtld_fini with atexit
    (for dynamic linker cleanup);
}

partition "Constructor Phase" #E8F5E9 {
  :Run **.preinit_array** functions
    (rarely used, before shared lib inits);
  :Call __libc_csu_init;
  :Run **.init** function (legacy);
  :Run **.init_array** constructors
    in registration order;
}

partition "Main Execution" #FFFDE7 {
  :Call **main(argc, argv, envp)**;
  :--- User program executes ---;
  :main() returns with exit code;
}

partition "Shutdown Phase" #FFF3E0 {
  :exit() called with return code;
  :Run **atexit() handlers** in
    LIFO order (last registered = first run);
  :Run **.fini_array** destructors
    in reverse order;
  :Run **.fini** function (legacy);
  :Flush all stdio streams
    (fflush on stdout, stderr, etc.);
  :Close all stdio streams;
}

partition "Kernel Cleanup" #FFEBEE {
  :Call **_exit(code)** syscall
    (exit_group on Linux);
  :Kernel closes all open
    file descriptors;
  :Kernel frees all memory
    mappings (text, data, heap, stack);
  :Kernel sends SIGCHLD
    to parent process;
  :Exit status stored in
    task_struct for wait();
}

stop

@enduml
