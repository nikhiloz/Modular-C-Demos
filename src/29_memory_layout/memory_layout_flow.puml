@startuml
skinparam backgroundColor #FEFEFE
skinparam defaultFontSize 13
skinparam activityBorderColor #333333
skinparam activityBackgroundColor #E8F4FD
skinparam activityDiamondBackgroundColor #FFF3CD
skinparam activityDiamondBorderColor #856404
skinparam roundCorner 8
skinparam shadowing false

title Memory Allocation Lifecycle

start

partition "Program Loading" {
  :Kernel maps **.text** segment
    (R-X: read + execute);
  :Kernel maps **.rodata** segment
    (R--: read only);
  :Kernel maps **.data** segment
    (RW-: initialized globals);
  :Kernel zeroes **.bss** segment
    (RW-: uninitialized globals);
}

:_start runs (CRT startup code);
:__libc_start_main called;
:main() begins execution;

partition "Dynamic Memory (Heap)" {
  :Code calls **malloc(size)**;

  if (Is this the first heap allocation?) then (yes)
    :libc calls **brk()** to set
      initial program break;
  else (no)
  endif

  if (Requested size > 128KB threshold?) then (yes)
    :Use **mmap()** for this allocation
      (allocated in mmap region);
  else (no)
    :Extend heap via **sbrk()**
      or use existing free chunks;
  endif

  :Return pointer to caller;
}

partition "Using Memory" {
  :Program reads/writes allocated memory;

  :Code calls **free(ptr)**;

  if (Was this allocation via mmap?) then (yes)
    :Call **munmap()** to release
      pages back to kernel;
  else (no: heap allocation)
    :Return block to free list
      (managed by malloc internals);
    :Memory stays mapped but
      available for future malloc;
  endif
}

partition "Stack Memory" {
  :Function call occurs;
  :Stack pointer decremented
    (auto variables allocated);
  :Local variables live on stack frame;
  :Function returns;
  :Stack pointer restored
    (locals automatically released);
}

partition "Program Exit" {
  :main() returns or exit() called;
  :atexit handlers and destructors run;
  :libc calls _exit() syscall;
  :Kernel releases ALL mappings:
    text, data, heap, stack, mmap regions;
  :Process resources fully reclaimed;
}

stop

@enduml
