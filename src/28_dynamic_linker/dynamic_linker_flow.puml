@startuml
skinparam backgroundColor #FEFEFE
skinparam defaultFontSize 13
skinparam activityBorderColor #333333
skinparam activityBackgroundColor #E8F4FD
skinparam activityDiamondBackgroundColor #FFF3CD
skinparam activityDiamondBorderColor #856404
skinparam roundCorner 8
skinparam shadowing false

title Dynamic Linker (ld.so) Startup Flow

start

:Kernel loads **ld.so** and transfers
  control to its entry point;

:Read executable's **PT_DYNAMIC**
  segment from auxiliary vector;

:Parse **DT_NEEDED** list
  (names of required shared libraries);

while (More DT_NEEDED entries to process?) is (yes)
  :Get next library name from DT_NEEDED;

  partition "Library Search Order" {
    :1. Check DT_RPATH from executable;
    :2. Check **LD_LIBRARY_PATH** env var;
    :3. Check DT_RUNPATH from executable;
    :4. Search **/etc/ld.so.cache**
       (ldconfig-generated cache);
    :5. Try default paths:
       /lib and /usr/lib;
  }

  :Found .so file at resolved path;

  :mmap the .so into process
    address space (PT_LOAD segments);

  :Process relocations for this .so:
    R_X86_64_GLOB_DAT (GOT entries)
    R_X86_64_JUMP_SLOT (PLT entries)
    R_X86_64_RELATIVE (base-relative);

  if (This .so has its own DT_NEEDED entries?) then (yes)
    :Add transitive dependencies
      to processing queue;
  else (no)
  endif

endwhile (no)

:Apply **RELRO** protection:
  mark GOT pages read-only
  (if full RELRO is enabled);

:Run **.init** functions
  for each loaded library;

:Run **.init_array** constructors
  for each loaded library
  (in dependency order);

:Transfer control to
  executable's **_start** address;

stop

@enduml
